generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  picture   String?
  password  String?  @map("password")
  googleId  String?  @unique @map("google_id")
  companyId String   @map("company_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Company {
  id        String   @id @default(cuid())
  name      String
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     User[]
  instances Instance[]

  messages       Message[]
  chatFlows      ChatFlow[]
  products       Product[]
  contacts       Contact[]
  aiSecretary    AISecretary?
  conversations  Conversation[]
  campaigns      Campaign[]
  secretaryTasks SecretaryTask[]
  integrations   ExternalIntegration[]

  @@map("companies")
}

model Contact {
  id            String   @id @default(cuid())
  remoteJid     String   @map("remote_jid")
  pushName      String?  @map("push_name")
  profilePicUrl String?  @map("profile_pic_url")
  notes         String?  @db.Text
  tags          String[] @default([])

  // Campos demográficos para segmentação
  cep          String? // CEP para auto-preencher cidade/estado via ViaCEP
  birthDate    DateTime? @map("birth_date")
  gender       String? // 'male' | 'female' | 'other'
  city         String?
  state        String?
  neighborhood String? // Bairro (preenchido via ViaCEP)
  university   String?
  course       String?
  occupation   String?

  // Lead scoring e análise de IA
  leadScore     Int?      @map("lead_score") // 0-100
  leadStatus    String?   @map("lead_status") // 'cold' | 'warm' | 'hot' | 'customer'
  aiAnalysis    String?   @map("ai_analysis") @db.Text // Análise detalhada da IA
  aiAnalyzedAt  DateTime? @map("ai_analyzed_at")
  totalMessages Int       @default(0) @map("total_messages")

  companyId  String   @map("company_id")
  instanceId String?  @map("instance_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  memories ContactMemory[]

  @@unique([remoteJid, companyId])
  @@map("contacts")
}

// Memória estruturada por contato - evita reprocessar todo histórico
model ContactMemory {
  id        String @id @default(cuid())
  contactId String @map("contact_id")

  // Tipo de memória
  type       String // 'fact' | 'preference' | 'need' | 'objection' | 'interest' | 'context'
  key        String // Ex: "nome_filho", "produto_interesse", "reclamacao"
  value      String  @db.Text // O valor da informação
  confidence Float   @default(1.0) // 0-1, confiança na informação
  source     String? // messageId de onde veio a info

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactId, type, key])
  @@index([contactId])
  @@map("contact_memories")
}

// Base de conhecimento da empresa - treinamento específico
model CompanyKnowledge {
  id        String @id @default(cuid())
  companyId String @map("company_id")

  category String // 'product' | 'faq' | 'policy' | 'objection_handler' | 'script' | 'error_correction'
  title    String
  content  String   @db.Text
  keywords String[] @default([]) // Para busca rápida
  priority Int      @default(0) // Maior = mais importante
  isActive Boolean  @default(true) @map("is_active")

  // Para correção de erros
  wrongResponse   String? @map("wrong_response") @db.Text
  correctResponse String? @map("correct_response") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, category])
  @@map("company_knowledge")
}

model Product {
  id        String   @id @default(cuid())
  name      String
  variant   String?
  quantity  Int      @default(0)
  price     Decimal  @db.Decimal(10, 2)
  sku       String?
  imageUrl  String?  @map("image_url")
  isActive  Boolean  @default(true) @map("is_active")
  companyId String   @map("company_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("products")
}

model ChatFlow {
  id        String   @id @default(cuid())
  name      String
  keyword   String
  isActive  Boolean  @default(true) @map("is_active")
  companyId String   @map("company_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  nodes   ChatNode[]

  @@map("chat_flows")
}

model ChatNode {
  id        String  @id @default(cuid())
  flowId    String  @map("flow_id")
  content   String  @db.Text
  type      String  @default("text") // text, button, list
  stepIndex Int     @map("step_index")
  parentId  String? @map("parent_id")

  flow ChatFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@map("chat_nodes")
}

model Instance {
  id          String   @id @default(cuid())
  name        String
  instanceKey String   @unique @map("instance_key")
  companyId   String   @map("company_id")
  status      String   @default("disconnected")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages      Message[]
  conversations Conversation[]

  @@map("instances")
}

model Message {
  id          String    @id @default(cuid())
  remoteJid   String    @map("remote_jid")
  messageId   String    @unique @map("message_id")
  content     String    @db.Text
  response    String?   @db.Text
  direction   String
  pushName    String?   @map("push_name")
  mediaUrl    String?   @map("media_url")
  mediaType   String?   @map("media_type") // 'image', 'video', 'audio', 'document'
  mediaData   Json?     @map("media_data") // JSON data for downloading media via Evolution API
  status      String    @default("pending") // 'pending' | 'processed' | 'failed'
  processedAt DateTime? @map("processed_at")
  companyId   String    @map("company_id")
  instanceId  String    @map("instance_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  instance Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([instanceId])
  @@index([remoteJid])
  @@map("messages")
}

model AISecretary {
  id                String    @id @default(cuid())
  companyId         String    @unique @map("company_id")
  enabled           Boolean   @default(false)
  mode              String    @default("passive") // 'passive' | 'active' | 'supervised'
  systemPrompt      String    @db.Text
  temperature       Float     @default(0.7)
  ownerPhone        String?   @map("owner_phone") // WhatsApp do dono para notificações
  ownerName         String?   @map("owner_name") // Nome do dono
  businessHours     String?   @map("business_hours") @db.Text // JSON com horários de funcionamento
  escalationWords   String?   @map("escalation_words") @db.Text // Palavras que sempre escalam para humano
  personality       String    @default("professional") // 'professional' | 'friendly' | 'casual'
  testMode          Boolean   @default(false) @map("test_mode") // Modo secretária pessoal
  ownerInstructions String?   @map("owner_instructions") @db.Text // Instruções temporárias do dono (ex: "diga que estou dormindo")
  instructionsUntil DateTime? @map("instructions_until") // Até quando as instruções são válidas
  transcribeAudio   Boolean   @default(true) @map("transcribe_audio") // Transcrever áudios automaticamente
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("ai_secretaries")
}

model Conversation {
  id            String   @id @default(cuid())
  remoteJid     String   @map("remote_jid")
  companyId     String   @map("company_id")
  instanceId    String   @map("instance_id")
  status        String   @default("active") // 'active' | 'resolved' | 'archived'
  assignedTo    String?  @map("assigned_to") // 'ai' | 'human' | null
  priority      String   @default("normal") // 'low' | 'normal' | 'high' | 'urgent'
  summary       String?  @db.Text
  aiEnabled     Boolean  @default(true) @map("ai_enabled") // IA habilitada nesta conversa
  lastMessageAt DateTime @map("last_message_at")
  createdAt     DateTime @default(now()) @map("created_at")

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  instance Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([remoteJid, companyId])
  @@map("conversations")
}

model AIInteraction {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  messageId      String   @map("message_id")
  action         String // 'responded' | 'escalated' | 'summarized' | 'suggested'
  reasoning      String?  @db.Text
  confidence     Float?
  humanOverride  Boolean  @default(false) @map("human_override")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("ai_interactions")
}

model Campaign {
  id          String    @id @default(cuid())
  name        String
  message     String    @db.Text
  mediaUrl    String?   @map("media_url")
  mediaType   String?   @map("media_type") // 'image' | 'video' | 'document'
  status      String    @default("draft") // 'draft' | 'scheduled' | 'running' | 'completed' | 'cancelled'
  scheduledAt DateTime? @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Segmentation filters
  targetAll          Boolean  @default(false) @map("target_all") // Send to all contacts
  targetTags         String[] @default([]) @map("target_tags")
  targetGenders      String[] @default([]) @map("target_genders")
  targetCities       String[] @default([]) @map("target_cities")
  targetStates       String[] @default([]) @map("target_states")
  targetUniversities String[] @default([]) @map("target_universities")
  targetCourses      String[] @default([]) @map("target_courses")
  targetMinAge       Int?     @map("target_min_age")
  targetMaxAge       Int?     @map("target_max_age")

  companyId  String   @map("company_id")
  instanceId String?  @map("instance_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  recipients CampaignRecipient[]

  @@map("campaigns")
}

model CampaignRecipient {
  id         String    @id @default(cuid())
  campaignId String    @map("campaign_id")
  remoteJid  String    @map("remote_jid")
  status     String    @default("pending") // 'pending' | 'sent' | 'failed'
  sentAt     DateTime? @map("sent_at")
  error      String?
  createdAt  DateTime  @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("campaign_recipients")
}

// Tarefas automatizadas da secretária
model SecretaryTask {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  
  // Metadata
  name        String              // Nome curto da tarefa (ex: "Modo Dormir")
  description String   @db.Text   // Descrição detalhada
  
  // Condições (quando executar)
  // 'time_range' - Horário específico
  // 'keyword' - Palavra-chave na mensagem
  // 'first_message' - Primeira mensagem do contato
  // 'owner_inactive' - Dono inativo por X minutos  
  // 'always' - Sempre executa antes da resposta padrão
  triggerType   String   @map("trigger_type")
  triggerConfig Json     @map("trigger_config")  // Configuração específica do trigger
  
  // Ação (o que fazer)
  // 'send_message' - Enviar mensagem automática
  // 'add_to_response' - Adicionar texto à resposta da IA
  // 'forward_owner' - Notificar/encaminhar ao dono
  // 'set_tag' - Adicionar tag ao contato
  actionType    String   @map("action_type")
  actionConfig  Json     @map("action_config")   // Configuração específica da ação
  
  // Controle
  isActive    Boolean  @default(true)   @map("is_active")
  priority    Int      @default(5)      // 1-10, maior = mais prioritário
  
  // Audit
  createdAt   DateTime @default(now())  @map("created_at")
  updatedAt   DateTime @updatedAt       @map("updated_at")
  createdBy   String?  @map("created_by") // 'owner_chat', 'dashboard', etc
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId, isActive])
  @@map("secretary_tasks")
}

// Integrações externas (Gastometria, etc)
model ExternalIntegration {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  
  provider    String   // 'gastometria', 'google_calendar', etc
  
  // Credenciais encriptadas (para re-autenticação)
  encryptedEmail    String?  @map("encrypted_email") @db.Text
  encryptedPassword String?  @map("encrypted_password") @db.Text
  
  // Tokens
  accessToken  String?  @map("access_token") @db.Text
  refreshToken String?  @map("refresh_token") @db.Text
  expiresAt    DateTime? @map("expires_at")
  
  // Dados extras (ex: walletId padrão do Gastometria)
  config       Json     @default("{}")
  
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, provider])
  @@map("external_integrations")
}

